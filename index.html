
import React, { useState, useEffect, useCallback } from 'react';
// FIX: Use a default import for algoliasearch to comply with ES module standards, resolving the 'not callable' error.
import algoliasearch from 'algoliasearch/lite';
import { type Fatwa } from './types';
import { ALGOLIA_APP_ID, ALGOLIA_SEARCH_ONLY_KEY, ALGOLIA_INDEX_NAME, FATWA_BASE_URL, RANDOM_SEARCH_TERMS } from './constants';
import SearchInput from './components/SearchInput';
import LoadingSpinner from './components/LoadingSpinner';
import FatwaList from './components/FatwaList';
import FatwaDetail from './components/FatwaDetail';
import FeaturedQuestions from './components/FeaturedQuestions';
import { BookIcon } from './components/Icons';
import ThemeToggle from './components/ThemeToggle';

// --- Algolia Client ---
const algoliaClient = algoliasearch(ALGOLIA_APP_ID, ALGOLIA_SEARCH_ONLY_KEY);
const algoliaIndex = algoliaClient.initIndex(ALGOLIA_INDEX_NAME);

const App: React.FC = () => {
  const [fatwas, setFatwas] = useState<Fatwa[]>([]);
  const [selectedFatwa, setSelectedFatwa] = useState<Fatwa | null>(null);
  const [relatedFatwas, setRelatedFatwas] = useState<Fatwa[]>([]);
  const [isLoading, setIsLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const [listTitle, setListTitle] = useState<string>('فتاوى مختارة');
  const [theme, setTheme] = useState<'light' | 'dark'>(() => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      return savedTheme as 'light' | 'dark';
    }
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark';
    }
    return 'light';
  });

  useEffect(() => {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
    localStorage.setItem('theme', theme);
  }, [theme]);

  const toggleTheme = () => {
    setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
  };

  const fetchFatwaDetails = useCallback(async (id: number): Promise<Fatwa> => {
    const response = await fetch(`${FATWA_BASE_URL}fatwa_${id}.html`);
    if (!response.ok) {
      throw new Error(`تعذر العثور على الفتوى رقم ${id}.`);
    }
    const htmlText = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlText, 'text/html');

    const question = doc.getElementById('q')?.innerHTML.trim() || 'لم يتم العثور على السؤال';
    const answer = doc.getElementById('a')?.innerHTML.trim() || 'لم يتم العثور على الجواب';
    
    return {
      id: id,
      question: question,
      answer: answer,
      source: `fatwa_${id}.html`
    };
  }, []);

  const fetchRelatedFatwas = useCallback(async (fatwa: Fatwa) => {
    if (!fatwa.question || fatwa.question.trim().length === 0) {
        setRelatedFatwas([]);
        return;
    }

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = fatwa.question;
    const questionText = tempDiv.textContent || tempDiv.innerText || '';

    const keywords = questionText.split(' ').filter(word => word.length > 3).slice(0, 4).join(' ');
    const query = keywords || questionText.split(' ')[0];

    if (!query) {
        setRelatedFatwas([]);
        return;
    }
    
    try {
        const { hits } = await algoliaIndex.search(query, { hitsPerPage: 6 });
        const filteredItems: Fatwa[] = hits
            .map(hit => ({
                id: parseInt(hit.objectID!, 10),
                question: hit.question || '',
                answer: '',
                source: `fatwa_${hit.objectID!}.html`,
            }))
            .filter(item => item.id !== fatwa.id)
            .slice(0, 5);
        setRelatedFatwas(filteredItems);
    } catch (err) {
        console.error("Failed to fetch related fatwas:", err);
        setRelatedFatwas([]);
    }
  }, []);

  const searchFatwas = useCallback(async (query: string) => {
    setIsLoading(true);
    setError(null);
    setSelectedFatwa(null);
    setRelatedFatwas([]);
    
    try {
        const { hits } = await algoliaIndex.search(query);
        const results: Fatwa[] = hits.map(hit => ({
            id: parseInt(hit.objectID!, 10),
            question: hit.question || '',
            answer: '', // Will be fetched on demand
            source: `fatwa_${hit.objectID!}.html`,
        }));
        setFatwas(results);
    } catch (err) {
        setError('حدث خطأ أثناء البحث.');
        setFatwas([]);
    } finally {
        setIsLoading(false);
    }
  }, []);
  
  const handleIdClick = useCallback(async (id: number) => {
    setIsLoading(true);
    setSelectedFatwa(null);
    setError(null);
    try {
        const fullFatwa = await fetchFatwaDetails(id);
        setSelectedFatwa(fullFatwa);
        fetchRelatedFatwas(fullFatwa);
    } catch(err: any) {
        setError(err.message);
    } finally {
        setIsLoading(false);
        window.scrollTo(0, 0);
    }
  }, [fetchFatwaDetails, fetchRelatedFatwas]);
  
  useEffect(() => {
    const randomTerm = RANDOM_SEARCH_TERMS[Math.floor(Math.random() * RANDOM_SEARCH_TERMS.length)];
    setListTitle('فتاوى مختارة');
    searchFatwas(randomTerm);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const handleSearch = (query: string) => {
    setListTitle(`نتائج البحث عن: "${query}"`);
    const potentialId = parseInt(query.trim(), 10);
    if (/^\d+$/.test(query.trim()) && !isNaN(potentialId)) {
        setFatwas([]); // Clear the list for a direct ID search
        handleIdClick(potentialId);
    } else {
        searchFatwas(query);
    }
  };

  const handleFatwaSelect = useCallback(async (fatwa: Fatwa) => {
    setIsLoading(true);
    setSelectedFatwa(null);
    setError(null);
    try {
        const fullFatwa = await fetchFatwaDetails(fatwa.id);
        setSelectedFatwa(fullFatwa);
        fetchRelatedFatwas(fullFatwa);
    } catch(err: any) {
        setError(err.message);
    } finally {
        setIsLoading(false);
        window.scrollTo(0, 0);
    }
  }, [fetchFatwaDetails, fetchRelatedFatwas]);

  const handleBackToList = () => {
    setSelectedFatwa(null);
    setRelatedFatwas([]);
  };

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
      <main className="container mx-auto px-4 py-8 relative">
        <div className="absolute top-4 left-4 z-10">
            <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
        </div>
        <header className="text-center mb-8">
            <div className="flex justify-center items-center gap-4 text-emerald-600 dark:text-emerald-400">
                <BookIcon className="w-12 h-12"/>
                <h1 className="text-5xl font-bold">موسوعة الفتاوى</h1>
            </div>
            <p className="mt-4 text-lg text-gray-600 dark:text-gray-400">
                محرك بحث متخصص في الفتاوى الشرعية مع إمكانية التنقل بين الفتاوى المترابطة
            </p>
        </header>

        {!selectedFatwa && <FeaturedQuestions fatwas={fatwas} onQuestionClick={handleFatwaSelect} />}
        
        <SearchInput onSearch={handleSearch} isLoading={isLoading} />
        
        {error && <div className="text-center text-red-500 bg-red-100 dark:bg-red-900 dark:text-red-300 p-4 rounded-md my-4 whitespace-pre-wrap">{error}</div>}
        
        <div className="mt-10">
            {isLoading ? (
                <LoadingSpinner />
            ) : selectedFatwa ? (
                <FatwaDetail 
                  fatwa={selectedFatwa} 
                  onIdClick={handleIdClick} 
                  onBack={handleBackToList}
                  relatedFatwas={relatedFatwas}
                  onRelatedFatwaSelect={handleFatwaSelect}
                />
            ) : (
                <FatwaList fatwas={fatwas} onFatwaSelect={handleFatwaSelect} title={listTitle} />
            )}
        </div>
      </main>
    </div>
  );
};

export default App;
